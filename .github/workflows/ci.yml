name: CI

on:
  push:
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Syntax check
        run: |
          python - <<'PY'
          import py_compile
          from pathlib import Path
          files = [p for p in Path('.').rglob('*.py')]
          failed = []
          for f in files:
              try:
                  py_compile.compile(str(f), doraise=True)
              except Exception as e:
                  failed.append(f"{f}: {e}")
          if failed:
              print("❌ Syntax errors:")
              for err in failed:
                  print(" -", err)
              raise SystemExit(1)
          print(f"✅ OK: {len(files)} files compiled")
          PY
      - name: Import smoke
        run: |
          python - <<'PY'
          import importlib.util, sys
          from pathlib import Path
          main = Path("positions_guard.py")
          if not main.exists():
              print("⚠ positions_guard.py not found (skip)"); sys.exit(0)
          spec = importlib.util.spec_from_file_location("positions_guard", main)
          mod = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(mod)
          print("✅ positions_guard imported")
          PY
